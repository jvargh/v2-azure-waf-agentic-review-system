import React, { useMemo, useState } from 'react';
import { useAssessments } from '../context/AssessmentsContext';
import { PillarScore, Recommendation } from '../types';

const ResultsScorecardTab: React.FC = () => {
  const { selected } = useAssessments();
  
  // Use pillarResults (new format) or fallback to pillarScores (legacy)
  const pillarResults = selected?.pillarResults || selected?.pillarScores || [];
  const crossPillarConflicts = selected?.crossPillarConflicts || [];
  const overallScore = selected?.overallArchitectureScore;
  
  // Extract all recommendations from pillar results
  const allRecommendations = useMemo(() => {
    const recs: Recommendation[] = [];
    pillarResults.forEach((pillar: PillarScore) => {
      if (pillar.recommendations) {
        pillar.recommendations.forEach(rec => {
          recs.push({
            ...rec,
            pillar: pillar.pillar
          });
        });
      }
    });
    return recs;
  }, [pillarResults]);
  
  const overall = useMemo(() => {
    if (overallScore !== undefined) return overallScore;
    if (!pillarResults.length) return 0;
    const sum = pillarResults.reduce((acc: number, p: PillarScore) => {
      return acc + (p.overallScore || p.score || 0);
    }, 0);
    return +(sum / pillarResults.length).toFixed(1);
  }, [pillarResults, overallScore]);

  function ringPct() {
    const pct = Math.min(Math.max(overall, 0), 100);
    return pct + '%';
  }

  function scoreClass(score: number) {
    if (score >= 80) return 'excellent';
    if (score >= 60) return 'good';
    return 'poor';
  }

  // Expansion state moved to top-level to comply with React Hooks rules
  const [expandedSubcats, setExpandedSubcats] = useState<Record<string, boolean>>({});
  const [expandedPillars, setExpandedPillars] = useState<Record<string, boolean>>({});

  // Generate dynamic scoring explanation using Reliability pillar data
  const scoringExplanation = useMemo(() => {
    const reliabilityPillar = pillarResults.find((p: PillarScore) => p.pillar === 'Reliability');
    if (!reliabilityPillar) {
      // Fallback to generic explanation
      return (
        <>
          Each pillar is evaluated across multiple subcategories representing specific Azure Well-Architected best practices. 
          Subcategory scores reflect how comprehensively your architecture documentation addresses each specific area. 
          Higher subcategory scores indicate that area is well-documented with strong evidence of best practice implementation, 
          while lower scores suggest less coverage or weaker implementation details. The <strong>overall pillar score</strong> represents 
          the comprehensive assessment of all subcategories, normalized to a 0-100 scale. The <strong>Overall Architecture Score</strong> 
          at the top is the average of all five pillar scores.
        </>
      );
    }

    const subcats = reliabilityPillar.subcategories || {};
    const categories = reliabilityPillar.categories || Object.keys(subcats).map(name => ({
      name,
      score: subcats[name]
    }));
    const pillarScore = reliabilityPillar.overallScore ?? reliabilityPillar.score ?? 0;
    
    // Get first 3 subcategories as examples
    const exampleSubcats = categories.slice(0, 3);
    const subcatSum = categories.reduce((sum: number, c: any) => sum + (c.score || 0), 0);
    
    return (
      <>
        Each pillar is evaluated across multiple subcategories. For example, <strong>Reliability</strong> includes subcategories like{' '}
        {exampleSubcats.map((c: any, idx: number) => (
          <span key={idx}>
            "{c.name}" (score: {c.score}){idx < exampleSubcats.length - 1 ? ', ' : ''}
          </span>
        ))}
        {categories.length > 3 && `, and ${categories.length - 3} more`}. 
        These subcategory scores reflect how well your architecture documentation addresses each specific areaâ€”higher scores 
        indicate strong evidence and implementation details, lower scores suggest gaps. In this assessment, Reliability's {categories.length} subcategories 
        sum to {subcatSum} points, which normalizes to the <strong>pillar score of {pillarScore}</strong> on a 0-100 scale. 
        The <strong>Overall Architecture Score</strong> ({overall}) is the average of all five pillar scores, providing a holistic view 
        of your architecture's maturity. Confidence levels (High/Medium/Low) indicate documentation quality and completeness.
      </>
    );
  }, [pillarResults, overall]);

  return (
    <div>
      <h3>Well-Architected Scorecard</h3>
      {pillarResults.length === 0 && <p style={{ fontSize:'.75rem', color:'#555' }}>Scorecard will appear after analysis completes.</p>}
      {pillarResults.length > 0 && (
        <>
          <div className="overall-score-ring" style={{ ['--pct' as any]: ringPct() }}>
            <span>{overall}%</span>
          </div>
          <div style={{ textAlign:'center', fontSize:'.75rem', fontWeight:600, marginTop:'-.5rem' }}>Overall Architecture Score</div>
          
          {/* Cross-Pillar Conflicts Section */}
          {crossPillarConflicts.length > 0 && (
            <div style={{ marginTop:'1.5rem', padding:'.75rem', backgroundColor:'#fff3cd', borderRadius:'6px', border:'1px solid #ffc107' }}>
              <h4 style={{ margin:'0 0 .5rem', fontSize:'.85rem', color:'#856404' }}>âš  Cross-Pillar Considerations</h4>
              {crossPillarConflicts.map((conflict, idx) => (
                <div key={idx} style={{ fontSize:'.7rem', marginBottom:'.5rem', color:'#856404' }}>
                  <strong>{conflict.pillarA} â†” {conflict.pillarB}:</strong> {conflict.description}
                  <div style={{ fontSize:'.65rem', marginTop:'.25rem', paddingLeft:'1rem' }}>
                    ðŸ’¡ <em>{conflict.mitigation}</em>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          <h4 style={{ margin:'2rem 0 .5rem' }}>Pillar Breakdown</h4>
          <div className="scorecard-grid">
            {pillarResults.map((pillar: PillarScore) => {
              const subcats = pillar.subcategories || {};
              const categories = pillar.categories || Object.keys(subcats).map(name => ({
                name,
                score: subcats[name]
              }));
              // Fallback: compute average if overall score is zero but we have categories
              let rawScore = pillar.overallScore ?? pillar.score ?? 0;
              if ((!rawScore || rawScore === 0) && categories.length) {
                const avg = categories.reduce((a: number, c: any) => a + (c.score || 0), 0) / categories.length;
                rawScore = Math.round(avg);
              }
              const pillarScore = rawScore;
              
              // Determine confidence level - if backend didn't provide it, infer from score
              let confidence = pillar.confidence || 'Low';
              if (!pillar.confidence) {
                // Infer confidence if not provided by backend
                if (pillarScore >= 70) confidence = 'High';
                else if (pillarScore >= 40) confidence = 'Medium';
                else confidence = 'Low';
              }
              
              const confidenceColor = confidence === 'High' ? '#28a745' : confidence === 'Medium' ? '#ffc107' : '#dc3545';
              const confidenceTooltip = 
                confidence === 'High' 
                  ? 'High confidence: Comprehensive documentation with >70% concept coverage' 
                  : confidence === 'Medium'
                  ? 'Medium confidence: Moderate documentation with 30-70% concept coverage'
                  : 'Low confidence: Minimal documentation with <30% concept coverage. Consider adding more architectural details.';
              
              const expanded = expandedSubcats[pillar.pillar] || false;
              const visibleCategories = expanded ? categories : categories.slice(0, 5);
              return (
                <div key={pillar.pillar} className="score-card">
                  <h3>
                    {pillar.pillar}
                    <span 
                      title={confidenceTooltip}
                      style={{ 
                        marginLeft: '.5rem',
                        padding: '.15rem .4rem',
                        backgroundColor: confidenceColor,
                        color: 'white',
                        fontSize: '.55rem',
                        fontWeight: 600,
                        borderRadius: '3px',
                        cursor: 'help'
                      }}
                    >
                      {confidence}
                    </span>
                  </h3>
                  <div className="score" style={{ color: confidenceColor }}>{pillarScore}</div>
                  <div style={{ marginTop:'.5rem' }}>
                    {visibleCategories.map((c: any) => (
                      <div key={c.name} className="subcat">
                        <span style={{ fontSize:'.65rem' }}>{c.name}</span>
                        <span style={{ fontSize:'.65rem' }}>{c.score}</span>
                      </div>
                    ))}
                    {categories.length > 5 && (
                      <button
                        type="button"
                        onClick={() => setExpandedSubcats(prev => ({ ...prev, [pillar.pillar]: !expanded }))}
                        style={{
                          marginTop:'.35rem',
                          background:'transparent',
                          border:'none',
                          padding:0,
                          cursor:'pointer',
                          color:'#0078d4',
                          fontSize:'.6rem',
                          fontWeight:600
                        }}
                      >
                        {expanded ? 'Collapse' : `+${categories.length - 5} more subcategories`}
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
          
          <div style={{ 
            fontSize:'.65rem', 
            color:'#586069', 
            margin:'1.5rem 0', 
            padding:'.75rem', 
            backgroundColor:'#f6f8fa', 
            borderRadius:'6px',
            lineHeight:'1.4'
          }}>
            <strong style={{ color:'#24292e' }}>How Scores Work:</strong> {scoringExplanation}
          </div>
          
          <div className="recs">
            <h4 style={{ margin:'1.5rem 0 .75rem' }}>Recommendations by Pillar</h4>
            {pillarResults.map((pillar: PillarScore) => {
              const pillarRecs = pillar.recommendations || [];
              if (pillarRecs.length === 0) return null;
              
              // Sort recommendations by priority: Critical > High > Medium > Low
              const priorityOrder: Record<string, number> = { 
                'critical': 1, 
                'high': 2, 
                'medium': 3, 
                'low': 4 
              };
              const sortedRecs = [...pillarRecs].sort((a, b) => {
                const aPriority = (a.priority || 'medium').toLowerCase();
                const bPriority = (b.priority || 'medium').toLowerCase();
                return (priorityOrder[aPriority] || 5) - (priorityOrder[bPriority] || 5);
              });
              
              const pillarExpanded = expandedPillars[pillar.pillar] !== undefined ? expandedPillars[pillar.pillar] : true;
              
              return (
                <div key={pillar.pillar} style={{ marginBottom:'1.5rem', border:'1px solid #e1e4e8', borderRadius:'6px', overflow:'hidden' }}>
                  <div 
                    onClick={() => setExpandedPillars(prev => ({ ...prev, [pillar.pillar]: !pillarExpanded }))}
                    style={{ 
                      padding:'.75rem',
                      backgroundColor:'#f6f8fa',
                      cursor:'pointer',
                      display:'flex',
                      alignItems:'center',
                      justifyContent:'space-between',
                      userSelect:'none'
                    }}
                  >
                    <h5 style={{ margin:0, fontSize:'.85rem', color:'#0078d4', fontWeight:600 }}>
                      {pillarExpanded ? 'â–¼' : 'â–¶'} {pillar.pillar} ({pillarRecs.length} recommendation{pillarRecs.length > 1 ? 's' : ''})
                    </h5>
                  </div>
                  {pillarExpanded && (
                    <div style={{ padding:'1rem' }}>
                      {sortedRecs.map((rec: Recommendation, idx: number) => {
                    const priorityClass = (rec.priority || 'medium').toLowerCase();
                    const priorityColor = priorityClass === 'critical' ? '#dc3545' : priorityClass === 'high' ? '#fd7e14' : priorityClass === 'medium' ? '#ffc107' : '#28a745';
                    const reasoning = rec.reasoning || rec.insight || '';
                    // UI CHANGE: Remove Description section; always show Recommendation using description content.
                    // If reasoning empty, fallback to original recommendation fields.
                    const recommendation = reasoning || (rec as any).recommendation || rec.details || 'No recommendation available';
                    const source = rec.source || 'Unknown Subcategory';
                    
                    // Azure Learn URL mapping for Well-Architected subcategories
                    const azureDocsMap: Record<string, string> = {
                      // Reliability
                      'Reliability-Focused Design Foundations': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/simplify',
                      'Identify and Rate User and System Flows': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/identify-flows',
                      'Perform Failure Mode Analysis (FMA)': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/failure-mode-analysis',
                      'Define Reliability and Recovery Targets': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/metrics',
                      'Add Redundancy at Different Levels': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/redundancy',
                      'Implement a Timely and Reliable Scaling Strategy': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/scaling',
                      'Strengthen Resiliency with Self-Preservation and Self-Healing': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/self-preservation',
                      'Test for Resiliency and Availability Scenarios': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/testing-strategy',
                      'Implement Structured, Tested, and Documented Disaster Plans': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/disaster-recovery',
                      'Measure and Model the Solution\'s Health Indicators': 'https://learn.microsoft.com/en-us/azure/well-architected/reliability/monitoring',
                      // Security
                      'Establish a Security Baseline': 'https://learn.microsoft.com/en-us/azure/well-architected/security/establish-baseline',
                      'Maintain a Secure Development Lifecycle': 'https://learn.microsoft.com/en-us/azure/well-architected/security/secure-development-lifecycle',
                      'Classify and Label Data Sensitivity': 'https://learn.microsoft.com/en-us/azure/well-architected/security/data-classification',
                      'Create Intentional Segmentation and Perimeters': 'https://learn.microsoft.com/en-us/azure/well-architected/security/segmentation',
                      'Implement Conditional Identity and Access Management': 'https://learn.microsoft.com/en-us/azure/well-architected/security/identity-access',
                      // Operational Excellence
                      'Define standard practices to develop and operate workload': 'https://learn.microsoft.com/en-us/azure/well-architected/operational-excellence/formalize-development-practices',
                      'Formalize operational tasks': 'https://learn.microsoft.com/en-us/azure/well-architected/operational-excellence/formalize-operations-tasks',
                      'Formalize software ideation and planning': 'https://learn.microsoft.com/en-us/azure/well-architected/operational-excellence/formalize-software-ideation',
                      'Establish structured incident management': 'https://learn.microsoft.com/en-us/azure/well-architected/operational-excellence/incident-response',
                      'Automate repetitive tasks': 'https://learn.microsoft.com/en-us/azure/well-architected/operational-excellence/automate-tasks',
                      // Cost Optimization
                      'Create a culture of financial responsibility': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/culture',
                      'Create and maintain a cost model': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/cost-model',
                      'Collect and review cost data': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/collect-review-cost-data',
                      'Set spending guardrails': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/set-spending-guardrails',
                      'Optimize component costs': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/optimize-component-costs',
                      'Optimize flow costs': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/optimize-flow-costs',
                      'Optimize data costs': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/optimize-data-costs',
                      'Optimize code costs': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/optimize-code-costs',
                      'Optimize personnel time': 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/optimize-personnel-time',
                      // Performance Efficiency
                      'Performance Targets & SLIs/SLOs': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/performance-targets',
                      'Capacity & Demand Planning': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/capacity-planning',
                      'Performance Testing & Benchmarking': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/performance-test',
                      'Code & Runtime Optimization': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/optimize-code-infrastructure',
                      'Critical Flow Optimization': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/prioritize-critical-flows',
                      'Live Issue Triage & Remediation': 'https://learn.microsoft.com/en-us/azure/well-architected/performance-efficiency/continuous-performance-optimize'
                    };
                    const sourceUrl = azureDocsMap[source] || null;
                    
                    return (
                      <div key={idx} className="rec-card" style={{ marginBottom:'.75rem', position: 'relative' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '.5rem', marginBottom: '.75rem' }}>
                          <strong style={{ fontSize:'.8rem', flex: 1 }}>{rec.title}</strong>
                          <span style={{ 
                            padding: '.2rem .5rem', 
                            backgroundColor: priorityColor,
                            color: 'white',
                            fontSize: '.65rem',
                            fontWeight: 600,
                            borderRadius: '3px'
                          }}>
                            {rec.priority} Priority
                          </span>
                        </div>
                        
                        {/* Description removed per user request; content merged into Recommendation box */}
                        
                        <div className="recommendation-box" style={{ fontSize:'.7rem', marginBottom: '.55rem' }}>
                          <strong style={{ display:'block', fontWeight:600, marginBottom:'.25rem' }}>ðŸ’¡ Recommendation</strong>
                          <div style={{ color: '#333', lineHeight:'1.05rem' }}>{recommendation}</div>
                        </div>
                        
                        {/* Business Impact section with Impact, Effort, Source */}
                        <div className="business-impact-box" style={{ marginTop: '.5rem', fontSize: '.7rem' }}>
                          <strong style={{ display:'block', fontWeight:600, marginBottom:'.25rem' }}>ðŸ“Š Business Impact</strong>
                          <div style={{ lineHeight:'1.05rem' }}>
                            {(rec as any).business_impact || rec.impact}
                            <div style={{ marginTop:'.35rem', color:'#555' }}>
                              <strong>Effort:</strong> {rec.effort} {' | '} <strong>Source:</strong>{' '}
                              {sourceUrl ? (
                                <a href={sourceUrl} target="_blank" rel="noopener noreferrer" style={{ color:'#0078d4', textDecoration:'underline' }}>{source}</a>
                              ) : (
                                source
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {rec.crossPillarConsiderations && rec.crossPillarConsiderations.length > 0 && (
                          <div style={{ marginTop:'.5rem', padding:'.5rem', backgroundColor:'#f0f8ff', borderLeft:'3px solid #0078d4', fontSize:'.65rem' }}>
                            <strong>ðŸ”— Cross-Pillar Considerations:</strong>
                            {rec.crossPillarConsiderations.map((consideration, cIdx) => (
                              <div key={cIdx} style={{ marginTop:'.25rem' }}>{consideration}</div>
                            ))}
                          </div>
                        )}
                      </div>
                      );
                    })}
                    </div>
                  )}
                </div>
              );
            })}
            
            {allRecommendations.length === 0 && (
              <p style={{ fontSize:'.75rem', color:'#666' }}>No recommendations generated yet.</p>
            )}
          </div>
        </>
      )}
    </div>
  );
};

export default ResultsScorecardTab;
